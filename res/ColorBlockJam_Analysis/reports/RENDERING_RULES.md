# Color Block Jam - Правила рендерингу блоків

## Оновлено після аналізу рівнів 1-15

### 1. Координатна система

```
World координати → Grid координати:
- cellSizeWorld = 2.0
- offsetX = (gridSize.x - 1) / 2
- offsetY = (gridSize.y - 1) / 2
- col = round(worldX / cellSizeWorld + offsetX)
- row = round(-worldY / cellSizeWorld + offsetY)
```

**Примітка:** World Y вгору = Grid row вниз (інверсія)

### 2. Форми блоків (blockGroupType)

| ID | Назва | Базова форма | Опис |
|----|-------|--------------|------|
| 0 | Single | `X` | Одна клітинка |
| 1 | Double | `X / X` | Вертикальна 1x2, pivot знизу |
| 2 | Triple | `X / X / X` | Вертикальна 1x3, центрована |
| 3 | L | `X / X / X X` | L-форма з 4 клітинок |
| 4 | ReverseL | `X X / X / X` | Перевернута L з 4 клітинок |
| 5 | ShortL | `X X / __X` | Коротка L з 3 клітинок |
| 6 | Plus | `+ форма` | Хрест, центрований |
| 7 | TwoSquare | `X X / X X` | Квадрат 2x2 |
| 8 | ShortT | `X X X / __X` | Т-форма |
| 9 | Z | Z-форма | |
| 10 | ReverseZ | Перевернута Z | |
| 11 | U | U-форма | |

### 3. Спеціальні правила рендерингу

#### Double (blockGroupType = 1)
- **rotZ=1 (90°):** Зсув col-1 (вліво)
- **rotZ=2 (180°):** Зсув row-1 (вгору)

#### L (blockGroupType = 3)
- **rotZ=0:** Використовує дзеркальну форму `X X / _X / _X` + зсув col-1
  ```
  [[0, -1], [1, -1], [1, 0], [1, 1]]
  ```
- **rotZ=2 (180°):** Використовує оригінальну L форму `X / X / X X` + зсув col-1
  ```
  [[0, -1], [0, 0], [0, 1], [1, 1]]
  ```

#### ReverseL (blockGroupType = 4)
- **rotZ=2 (180°):** Зсув col-1

#### ShortL (blockGroupType = 5)
Складна логіка з урахуванням позиції та ротації:

- **rotZ=0:** Базова форма `X X / __X`
  ```
  [[-1, -1], [0, -1], [0, 0]]
  ```

- **rotZ=1:** Форма `X X / X__`
  ```
  [[0, 0], [1, 0], [0, 1]]
  ```
  - Спеціальна обробка для нижнього краю (atBottomEdge): row-1
  - Спеціальна обробка для правого-нижнього кута: col-1 + альтернативна форма

- **rotZ=2 (180°):** Форма `X__ / X X`
  ```
  [[0, 0], [0, 1], [1, 1]]
  ```
  - Зсув col-1
  - Якщо біля нижнього краю: також row-1

#### ShortT (blockGroupType = 8)
- **rotZ=0:** Зсув row-1 (вгору)
- **rotZ=2:** Зсув row+1 (вниз)

### 4. Кольорова палітра (blockType)

| ID | Колір | HEX |
|----|-------|-----|
| 0 | Blue (Синій) | #03a5ef |
| 1 | Dark Blue (Темно-синій) | #143cf6 |
| 2 | Green (Зелений) | #48aa1a |
| 3 | Pink (Рожевий) | #b844c8 |
| 4 | Purple (Фіолетовий) | #7343db |
| 5 | Yellow (Жовтий) | #fbb32d |
| 6 | Dark Green (Темно-зелений) | #09521d |
| 7 | Orange (Помаранчевий) | #f2772b |
| 8 | Red (Червоний) | #b8202c |
| 9 | Cyan (Бірюзовий) | #0facae |

### 5. Двері

#### Парсинг
- Діапазон пошуку: 0x84 - 0x900
- Валідні parts: 1-5 (більше - помилковий позитив)
- Динамічні пороги для країв:
  - `sideEdgeThreshold = max(3.5, gridSize.x + 0.5)`
  - `topBottomEdgeThreshold = max(5.5, gridSize.y - 0.5)`

#### Рендеринг
- Бокові двері (LEFT/RIGHT):
  - worldY < -2: менший зсув `floor((doorPartCount - 1) / 2)`
  - worldY >= -2: стандартний зсув `floor(doorPartCount / 2)`
- Верхні/нижні двері: центровані по колонках

### 6. Hidden Coords (Заховані клітинки)
- Y координата інвертується: `gridY = gridSize.y - 1 - coord.y`

### 7. Порядок рівнів у грі
- Визначається файлом `AllLevels_guids.json`
- GUID з цього файлу відповідає `guid` полю в parsed_levels_complete.json

### 8. Перевірені Game Levels

| Game Level | File Name | Статус |
|------------|-----------|--------|
| 1 | Level 1 | ✅ |
| 2 | Level 2 | ✅ |
| 3 | Level 3 | ✅ |
| 4 | Level 4 | ✅ |
| 5 | Level 5 | ✅ |
| 6 | Level 6 | ✅ |
| 7 | Level 8 | ✅ |
| 8 | Level 9 | ✅ |
| 9 | Derin Level 7 | ✅ |
| 10 | New Level 4 | ✅ |
| 11 | Level 45 | ✅ |
| 12 | Level 12 | ✅ |
| 13 | Level 14 | ✅ |
| 14 | Derin Level 9 | ✅ |
| 15 | Level 18 | ✅ |

## Використання

Ці правила застосовуються автоматично у візуалізаторі `level_visualizer.html`.
JSON файл `parsed_levels_complete.json` містить сирі дані без трансформацій.
Трансформації виконуються під час рендерингу на основі цих правил.
