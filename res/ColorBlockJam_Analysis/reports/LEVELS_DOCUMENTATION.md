# Color Block Jam - Детальна документація рівнів

## Зміст

1. [Формат даних рівня](#1-формат-даних-рівня)
2. [Структура бінарного файлу](#2-структура-бінарного-файлу)
3. [Типи блоків](#3-типи-блоків)
4. [Типи дверей](#4-типи-дверей)
5. [Елементи рівня](#5-елементи-рівня)
6. [Система координат](#6-система-координат)
7. [Приклади рівнів](#7-приклади-рівнів)
8. [Інструкція з відтворення](#8-інструкція-з-відтворення)

---

## 1. Формат даних рівня

### 1.1 JSON структура

Кожен рівень у `parsed_levels_complete.json` має таку структуру:

```json
{
  "file": "Level_1.bin",
  "file_size": 728,
  "name": "Level 1",
  "guid": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "gridSize": {"x": 4, "y": 5},
  "camera": {
    "position": {"x": 0.0, "y": -6.0, "z": -21.0},
    "rotation": {"x": 345.0, "y": 0.0, "z": 0.0},
    "fov": 60.0
  },
  "hiddenCoords": [],
  "doors": [...],
  "blocks": [...]
}
```

### 1.2 Опис полів

| Поле | Тип | Опис |
|------|-----|------|
| `file` | string | Ім'я бінарного файлу |
| `file_size` | int | Розмір файлу в байтах |
| `name` | string | Назва рівня |
| `guid` | string | Унікальний ідентифікатор (UUID формат) |
| `gridSize` | Vector2Int | Розмір ігрової сітки |
| `camera` | object | Налаштування камери |
| `hiddenCoords` | array | Приховані клітинки сітки |
| `doors` | array | Масив дверей |
| `blocks` | array | Масив блоків |

---

## 2. Структура бінарного файлу

### 2.1 Загальний формат (.bin)

```
┌─────────────────────────────────────────────────────────────┐
│ HEADER (0x00 - 0x1B)                                        │
│   28 байт - метадані/padding                                │
├─────────────────────────────────────────────────────────────┤
│ NAME SECTION (0x1C - ...)                                   │
│   4 байти  - довжина назви                                  │
│   N байт   - назва рівня (UTF-8)                            │
│   padding  - вирівнювання до 4 байт                         │
├─────────────────────────────────────────────────────────────┤
│ GUID SECTION                                                │
│   4 байти  - довжина GUID (завжди 36)                       │
│   36 байт  - GUID строка                                    │
│   padding  - вирівнювання до 4 байт                         │
├─────────────────────────────────────────────────────────────┤
│ GRID SECTION                                                │
│   4 байти  - Grid Size X (int32)                            │
│   4 байти  - Grid Size Y (int32)                            │
│   4 байти  - кількість прихованих координат                 │
│   N×8 байт - приховані координати (Vector2Int)              │
├─────────────────────────────────────────────────────────────┤
│ GRID COLOR SECTION                                          │
│   4 байти  - кількість кольорів сітки                       │
│   N×8 байт - дані кольорів                                  │
├─────────────────────────────────────────────────────────────┤
│ CAMERA SECTION                                              │
│   12 байт  - position (Vector3: x, y, z)                    │
│   12 байт  - rotation (Vector3: x, y, z)                    │
│   4 байти  - FOV (float)                                    │
├─────────────────────────────────────────────────────────────┤
│ DOORS SECTION                                               │
│   4 байти  - кількість дверей                               │
│   N×40 байт - дані дверей                                   │
├─────────────────────────────────────────────────────────────┤
│ BLOCKS SECTION                                              │
│   4 байти  - кількість блоків                               │
│   N×44 байт - дані блоків                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Структура блоку (44 байти)

```
Offset  Size  Type     Field              Опис
──────────────────────────────────────────────────────────────
0x00    4     float    position.x         X позиція в світі
0x04    4     float    position.y         Y позиція в світі
0x08    4     float    position.z         Z позиція в світі
0x0C    4     float    rotation.x         X ротація (градуси)
0x10    4     float    rotation.y         Y ротація (градуси)
0x14    4     float    rotation.z         Z ротація (градуси)
0x18    4     float    scale.x            X масштаб
0x1C    4     float    scale.y            Y масштаб
0x20    4     float    scale.z            Z масштаб
0x24    4     int32    blockGroupType     Тип форми блоку (enum)
0x28    4     int32    blockType          Колір блоку
──────────────────────────────────────────────────────────────
Total: 44 байти (0x2C)
```

### 2.3 Структура дверей (40 байт)

```
Offset  Size  Type     Field              Опис
──────────────────────────────────────────────────────────────
0x00    4     float    position.x         X позиція
0x04    4     float    position.y         Y позиція
0x08    4     float    position.z         Z позиція
0x0C    4     float    rotation.x         X ротація
0x10    4     float    rotation.y         Y ротація
0x14    4     float    rotation.z         Z ротація
0x18    4     int32    doorPartCount      Кількість частин дверей
0x1C    4     int32    blockType          Колір (відповідність блокам)
0x20    1     bool     hasStar            Чи є зірка
0x21    1     bool     isSwitchDoor       Чи є перемикачем
0x22    1     byte     padding            Вирівнювання
0x23    1     bool     hasIce             Чи покрито льодом
0x24    4     int32    iceCount           Кількість шарів льоду
──────────────────────────────────────────────────────────────
Total: 40 байт (0x28)
```

---

## 3. Типи блоків

### 3.1 BlockGroupType (форма блоку)

| ID | Назва | Візуалізація | Опис |
|----|-------|--------------|------|
| 0 | One | `■` | Одинарний блок 1×1 |
| 1 | Two | `■■` | Горизонтальний блок 1×2 |
| 2 | Three | `■■■` | Горизонтальний блок 1×3 |
| 3 | L | `■`<br>`■■` | L-подібний блок |
| 4 | ReverseL | `■`<br>`■■` (дзеркальний) | Зворотній L-блок |
| 5 | ShortL | `■`<br>`■■` (коротший) | Короткий L-блок |
| 6 | Plus | `·■·`<br>`■■■`<br>`·■·` | Хрестоподібний блок |
| 7 | TwoSquare | `■■`<br>`■■` | Квадратний блок 2×2 |
| 8 | ShortT | `■■■`<br>`·■·` | T-подібний блок |
| 9 | Z | `■■·`<br>`·■■` | Z-подібний блок |
| 10 | ReverseZ | `·■■`<br>`■■·` | Зворотній Z-блок |
| 11 | U | `■·■`<br>`■■■` | U-подібний блок |

### 3.2 BlockType (колір блоку)

Колір визначається числовим ID:

| ID | Типовий колір |
|----|---------------|
| 0 | Червоний |
| 1 | Синій |
| 2 | Зелений |
| 3 | Жовтий |
| 4 | Фіолетовий |
| 5 | Помаранчевий |
| 6 | Рожевий |
| 7 | Блакитний |
| 8+ | Додаткові кольори |

**Важливо**: Колір блоку повинен відповідати кольору дверей для проходження рівня.

### 3.3 Ротації блоків

Блоки можуть бути повернуті на:
- **0°** - стандартна орієнтація
- **90°** - поворот за годинниковою стрілкою
- **180°** - перевернутий
- **270°** - поворот проти годинникової стрілки

Поле `rotation.y` зазвичай містить кут повороту навколо вертикальної осі.

---

## 4. Типи дверей

### 4.1 Базові властивості

Двері - це цільові точки для блоків. Блок проходить через двері того ж кольору.

| Властивість | Опис |
|-------------|------|
| doorPartCount | Кількість секцій дверей (1-5) |
| blockType | Колір дверей (повинен збігатися з блоком) |
| hasStar | Бонусна зірка за проходження |
| isSwitchDoor | Двері-перемикач |
| hasIce | Покриті льодом (потрібно розбити) |
| iceCount | Кількість шарів льоду для розбиття |

### 4.2 Позиціонування дверей

Двері розміщуються на краях ігрового поля:
- **Нижній край**: rotation.y ≈ 0°
- **Верхній край**: rotation.y ≈ 180°
- **Лівий край**: rotation.y ≈ 90°
- **Правий край**: rotation.y ≈ 270°

---

## 5. Елементи рівня

### 5.1 LevelElementType

Спеціальні елементи на блоках або клітинках:

| ID | Назва | Функція |
|----|-------|---------|
| 0 | None | Без елемента |
| 1 | Ice | Лід - блок/двері покриті льодом |
| 2 | Star | Зірка - бонусний об'єкт |
| 3 | Key | Ключ - відкриває замки |
| 4 | Lock | Замок - потребує ключ |
| 5 | TimerBomb | Бомба з таймером |
| 6 | Curtain | Завіса - приховує елементи |
| 7 | Scissors | Ножиці - ріжуть мотузки |
| 8 | Ropes | Мотузки - обмежують рух |
| 9 | HiddenColor | Прихований колір |
| 10 | CountBomb | Лічильник бомби |

### 5.2 Додаткові властивості блоків

| Властивість | Тип | Опис |
|-------------|-----|------|
| isOneWayMovementActive | bool | Блок рухається лише в одному напрямку |
| oneWayMovementCounter | int | Лічильник ходів |
| wayDirection | int | Напрямок руху |
| isBlocker | bool | Блок-перешкода |
| isBlockerFixed | bool | Нерухома перешкода |
| blockerCounter | int | Лічильник перешкоди |
| isRainbow | bool | Веселковий блок (підходить до будь-яких дверей) |
| hasTimeCapsule | bool | Має капсулу часу |
| hasColorSwitcher | bool | Змінює колір |

---

## 6. Система координат

### 6.1 Світові координати

```
         +Y (вгору)
          │
          │
          │
          └───────── +X (вправо)
         /
        /
       +Z (до камери)
```

### 6.2 Сітка рівня

Сітка визначається як `gridSize.x × gridSize.y`:

```
┌─────────────────────────────┐
│  (0,4) (1,4) (2,4) (3,4)    │  ← верхній ряд
│  (0,3) (1,3) (2,3) (3,3)    │
│  (0,2) (1,2) (2,2) (3,2)    │  gridSize: 4×5
│  (0,1) (1,1) (2,1) (3,1)    │
│  (0,0) (1,0) (2,0) (3,0)    │  ← нижній ряд
└─────────────────────────────┘
    ↑                    ↑
  лівий              правий
   край               край
```

### 6.3 Перетворення координат

Світова позиція блоку → позиція на сітці:

```
gridX = round((worldPosition.x + offset) / cellSize)
gridY = round((worldPosition.y + offset) / cellSize)
```

Типовий розмір клітинки: ~1.5-2.0 одиниці

### 6.4 Приховані клітинки

Масив `hiddenCoords` містить координати клітинок, які відсутні на сітці:

```json
"hiddenCoords": [
  {"x": 0, "y": 0},
  {"x": 3, "y": 4}
]
```

Ці клітинки не відображаються і блоки не можуть на них знаходитися.

---

## 7. Приклади рівнів

### 7.1 Level 1 (Навчальний)

```json
{
  "name": "Level 1",
  "gridSize": {"x": 4, "y": 5},
  "camera": {
    "position": {"x": 0.0, "y": -6.0, "z": -21.0},
    "rotation": {"x": 345.0, "y": 0.0, "z": 0.0},
    "fov": 60.0
  },
  "blocks": [
    {
      "position": {"x": -4.56, "y": 5.52, "z": 0.0},
      "rotation": {"x": 270.0, "y": 0.0, "z": 0.0},
      "scale": {"x": 1.0, "y": 1.0, "z": 1.0},
      "blockGroupType": 0,
      "blockGroupTypeName": "One",
      "blockType": 0
    }
    // ... ще 7 блоків
  ],
  "doors": [
    {
      "position": {"x": -1.0, "y": -6.0, "z": 0.0},
      "rotation": {"x": 0.0, "y": 0.0, "z": 0.0},
      "doorPartCount": 3,
      "blockType": 3
    }
  ]
}
```

### 7.2 Складний рівень (з елементами)

```json
{
  "name": "Level 500",
  "gridSize": {"x": 8, "y": 9},
  "blocks": [
    {
      "blockGroupType": 3,
      "blockGroupTypeName": "L",
      "blockType": 2,
      "isBlocker": true,
      "blockerCounter": 3,
      "levelElement": {
        "type": 1,
        "typeName": "Ice",
        "iceCount": 2
      }
    }
  ],
  "doors": [
    {
      "doorPartCount": 4,
      "blockType": 2,
      "hasIce": true,
      "iceCount": 1
    }
  ]
}
```

---

## 8. Інструкція з відтворення

### 8.1 Необхідні компоненти

Для відтворення рівня в іншому ігровому движку потрібно:

1. **Сітка рівня** - gridSize визначає розміри
2. **Камера** - позиція, ротація, FOV
3. **Блоки** - позиція, форма, колір
4. **Двері** - позиція, колір, кількість частин

### 8.2 Алгоритм відтворення

```
1. Створити ігрове поле gridSize.x × gridSize.y
2. Видалити клітинки з hiddenCoords
3. Налаштувати камеру:
   - Позиція: camera.position
   - Ротація: camera.rotation
   - FOV: camera.fov
4. Для кожного блоку в blocks[]:
   a. Створити блок форми blockGroupTypeName
   b. Встановити позицію position
   c. Застосувати ротацію rotation
   d. Призначити колір blockType
5. Для кожних дверей в doors[]:
   a. Створити двері з doorPartCount секцій
   b. Встановити позицію position
   c. Призначити колір blockType
```

### 8.3 Приклад коду (псевдокод)

```python
def recreate_level(level_data):
    # Створити сітку
    grid = Grid(level_data['gridSize']['x'],
                level_data['gridSize']['y'])

    # Видалити приховані клітинки
    for coord in level_data['hiddenCoords']:
        grid.remove_cell(coord['x'], coord['y'])

    # Налаштувати камеру
    camera.position = level_data['camera']['position']
    camera.rotation = level_data['camera']['rotation']
    camera.fov = level_data['camera']['fov']

    # Створити блоки
    for block_data in level_data['blocks']:
        block = create_block(block_data['blockGroupTypeName'])
        block.position = block_data['position']
        block.rotation = block_data['rotation']
        block.color = get_color(block_data['blockType'])
        grid.add_block(block)

    # Створити двері
    for door_data in level_data['doors']:
        door = create_door(door_data['doorPartCount'])
        door.position = door_data['position']
        door.color = get_color(door_data['blockType'])
        grid.add_door(door)

    return grid
```

### 8.4 Форми блоків (для генерації мешів)

```
One (1×1):
  cells = [(0, 0)]

Two (1×2):
  cells = [(0, 0), (1, 0)]

Three (1×3):
  cells = [(0, 0), (1, 0), (2, 0)]

L:
  cells = [(0, 0), (0, 1), (1, 0)]

ReverseL:
  cells = [(0, 0), (1, 0), (1, 1)]

ShortL:
  cells = [(0, 0), (0, 1), (1, 1)]

Plus:
  cells = [(1, 0), (0, 1), (1, 1), (2, 1), (1, 2)]

TwoSquare (2×2):
  cells = [(0, 0), (1, 0), (0, 1), (1, 1)]

ShortT:
  cells = [(0, 0), (1, 0), (2, 0), (1, 1)]

Z:
  cells = [(0, 0), (1, 0), (1, 1), (2, 1)]

ReverseZ:
  cells = [(1, 0), (2, 0), (0, 1), (1, 1)]

U:
  cells = [(0, 0), (2, 0), (0, 1), (1, 1), (2, 1)]
```

### 8.5 Застосування ротації

```python
def rotate_cells(cells, rotation_y):
    """Поворот форми блоку навколо центру"""
    rotations = int(rotation_y / 90) % 4

    for _ in range(rotations):
        cells = [(-y, x) for x, y in cells]

    # Нормалізація до позитивних координат
    min_x = min(c[0] for c in cells)
    min_y = min(c[1] for c in cells)
    cells = [(x - min_x, y - min_y) for x, y in cells]

    return cells
```

---

## 9. Статистика рівнів

### 9.1 Загальна статистика

| Метрика | Значення |
|---------|----------|
| Всього рівнів | 1557 |
| Рівнів з блоками | 1557 (100%) |
| Рівнів з дверима | 1531 (98.3%) |
| Середня кількість блоків | 2.1 |
| Максимум блоків на рівні | 15+ |

### 9.2 Розподіл за розміром сітки

| Розмір | Кількість | Відсоток |
|--------|-----------|----------|
| 6×8 | 254 | 16.3% |
| 7×7 | 241 | 15.5% |
| 6×6 | 176 | 11.3% |
| 8×8 | 124 | 8.0% |
| 6×7 | 115 | 7.4% |
| 7×6 | 94 | 6.0% |
| 8×9 | 81 | 5.2% |
| 7×8 | 74 | 4.8% |
| Інші | 398 | 25.5% |

### 9.3 Розподіл за кількістю блоків

| Блоків | Рівнів | Відсоток |
|--------|--------|----------|
| 1 | 287 | 18.4% |
| 2 | 1031 | 66.2% |
| 3 | 112 | 7.2% |
| 4-7 | 63 | 4.0% |
| 8+ | 64 | 4.1% |

---

## 10. Файли в архіві

| Файл | Опис |
|------|------|
| `level_data/parsed_levels_complete.json` | Всі 1557 рівнів у JSON |
| `level_data/level_index.json` | Індекс рівнів з метаданими |
| `level_data/AllLevels_guids.json` | Список GUID всіх рівнів |
| `tools/level_parser_final.py` | Python парсер бінарних файлів |

---

*Документація створена: Грудень 2024*
